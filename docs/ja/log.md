# Log

DBMSはコミットされたトランザクションの永続化のため, ログを必要とする. このドキュメントではこのDBMSにおけるログについて説明する. 

本データベースではRedo logを主に用いる. すなわち実際のデータを書き込む前にログを
ファイルに書き込み(Write Ahead Logging), リカバリの際はログデータを用いてデータを再現することで永続性を保つ. 

ログはブロックごとに書き込まれるが, 最後に追加されたログがそのブロックのどこまで続いているのか
わかるようにするため, 各ブロックの初めの4byteは最後に追加されたログのオフセットを持つようにする. 

## ログを出力する単位

以下のタイミングでログを出力する. 

- トランザクションが開始したとき,
- ある型のアイテムが書き込まれたとき,
- トランザクションがコミットもしくはロールバックされたとき, 
- チェックポイントにおける処理が終了したとき,

すなわちログは一つのデータ単位(整数、文字列など)で書き込まれる. 

## ログフォーマット

ログの詳細なフォーマットは次のようである. まず各ログの先頭にChecksum(計算方法, 目的に関しては後述)とログの長さを書いて, 
そのあとにログの種類ごとにログ本体を出力する. ログの長さはbyte単位で記す. 

```
| Checksum | log length | log body |
```

各種類のログでのログの本体(log body)は次のようである.

### トランザクション開始

```
| 00 | transaction_id |
```

### 一つのアイテム(整数、文字列など)に対する操作

MANIP_TYPEは
- 追加: 00
- 更新: 01
- 削除: 10
として,

```
| 01 | transaction_id | MANIP_TYPE (2bits) | filename | offset | TYPE(4bits) | content | 
```

となる. offsetはバイト単位で記す. TYPEは整数, 固定長文字列などのデータアイテムの型を表すもので, contentはデータアイテムの値である. contentはデータアイテムを復元するのに用いられる.

### トランザクション終了

END_TYPEは
- コミット: 0
- ロールバック: 1
として,

```
| 10 | transaction_id | END_TYPE (1bit) |
```

### チェックポイント

これ以前のログに書かれた変更ははすべてディスクになされたことを示すログ. 

```
| 11 |
```

## ログのAtomicな追加

ログはアトミックに追加される必要がある. これは次のようにチェックサムを用いて実現する. 

1. 書き込むログ本体のチェックサムを計算する. 
2. Checksumを1. で計算したチェックサムとする. 

このようにすることでログを読み込んだときにその内容が完全であることをチェックサムを用いて確認することができる. すなわちログを読み込み, ログ本体のチェックサムとチェックサムが一致すればログは完全であり, そうでない場合は完全でない. 