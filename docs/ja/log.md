# Log

DBMSはコミットされたトランザクションの永続化のため, ログを必要とする. このドキュメントではこのDBMSにおけるログについて説明する. 

本データベースではRedo logを主に用いる. すなわち実際のデータを書き込む前にログを
ファイルに書き込み(Write Ahead Logging), リカバリの際はログデータを用いてデータを再現することで永続性を保つ. 

## ログを出力する単位

以下のタイミングでログを出力する. 

- トランザクションが開始したとき,
- ある型のアイテムが書き込まれたとき,
- トランザクションがコミットもしくはロールバックされたとき, 
- チェックポイントにおける処理が終了したとき,

すなわちログは一つのデータ単位(整数、文字列など)で書き込まれる. 

## ログフォーマット

ログの詳細なフォーマットは次のようである. まず各ログの先頭にChecksum(計算方法, 目的に関しては後述)とログの長さを書いて, 
そのあとにログの種類ごとにログ本体を出力する. ログの長さはチェックサムなどをふくまないログ本体のみの長さをbyte単位で記す.
またログを後ろから読むことができるようにログの長さは後ろにも出力する. 

```
| Checksum | log length | log body | log length |
```

各種類のログでのログの本体(log body)は次のようである.

### トランザクション開始

ログ本体は以下のようである.

```
| 0b00000000 | transaction_id |
```

### 一つのアイテム(整数、文字列など)に対する操作

ログ本体は以下のようである.
```
| 0b01{MANIP_TYPE(2bit)}{TYPE(4bit)} | transaction_id | filename | offset | type_parameter* | previous_content* | new_content* | 
```

- MANIP_TYPEは追加, 更新, 削除のいずれかを2bitであらわす.
- TYPEは整数, 固定長文字列などのデータアイテムの型を表す.
- filename, offsetはこのデータアイテムが書かれていた場所を指す.
- type_parameterは型に付随する値をあらわす. たとえば`Char`型の場合, 文字列の長さなどを持つ. これは`Int`のようにない場合もある.
- previous_contentはデータアイテムの以前のである. これは追加ログの場合はない.
- new_contentはデータアイテムの新しい値. これは削除ログの場合はない.

### トランザクション終了

ログ本体は以下のようである.
```
| 0b10{END_TYPE(1bit)}00000 | transaction_id |
```

- END_TYPEはコミットまたはロールバックを1bitであらわす.

### チェックポイント

これ以前のログに書かれた変更ははすべてディスクになされたことを示すログ. 

ログ本体は以下のようである.
```
| 0b11000000 |
```

## ログのAtomicな追加

ログはアトミックに追加される必要がある. これは次のようにチェックサムを用いて実現する. 

1. 書き込むログ本体のチェックサムを計算する. 
2. Checksumを1. で計算したチェックサムとする. 

このようにすることでログを読み込んだときにその内容が完全であることをチェックサムを用いて確認することができる. すなわちログを読み込み, ログ本体のチェックサムとチェックサムが一致すればログは完全であり, そうでない場合は完全でない. 