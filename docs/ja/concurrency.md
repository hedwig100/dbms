# Concurrency control

データベースにおいては, 複数のトランザクションが並列に動作する. その動作はACID特性
を満たしていなければならないが, ACID特性の一つであるIsolationはトランザクションが直列に
実行されたのと同じような結果でなければならない(serializability)ということを意味する. 
このSerializabilityを満たすようにするため, トランザクションの読み書きを制限する必要があり, その管理をどのように行うかについてここでは記す.

## 用語

- Serializability: 複数のトランザクションを並列に実行するとき, その読み書きの結果がそれらのトランザクションをある順番で直列に実行したときの結果と一致するときにその実行順序はserializabilityを持つという. 
- 排他ロック: ロックの一種であり, このロックを獲得している場合は, ほかのトランザクションはどんなロックも獲得できない.
- 共有ロック: ロックの一種であり, このロックを獲得している場合は, ほかのトランザクションは共有ロックは獲得できるが, 排他ロックは獲得できない.
- Two-phase lock (二相ロック): 各トランザクションはロックを一度解放したら, もうほかのロックを獲得することはできないようにするようなロックの方式のこと. 

## 概要

トランザクションはディスクのブロック単位でロックを掛ける. あるブロック上にあるデータを
読み出したいときに, 共有ロックを掛ける. またデータを書きっこみたいときには排他ロックを掛ける. 

いくつかの分離レベルが存在するが, とりあえず最も強い分離レベルであるSerializabilityを実現するものを実装する. 

デッドロックを回避するため, ロックを獲得しようとして一定時間が経過した場合はロック獲得が失敗したとみなす. ロック獲得が失敗した場合にもう一度ロックを獲得するか, ロールバックするかは確率的に決定するとする. 

## 実装

二つのクラス `LockTable`, `ConcurecyManager` を実装する. 

- `LockTable`
    - このオブジェクトはトランザクションで共有されるスレッドセーフなオブジェクト
    - どのブロックがロックされているかという情報を管理する. 
    - デッドロックが起きている場合はロック獲得に失敗する. 

- `ConcurrencyManager`
    - 各トランザクションが持つ.
    - ロックの獲得, 解放に責任を持つ.


